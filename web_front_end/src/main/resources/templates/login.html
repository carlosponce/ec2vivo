<!--
  ~ Copyright 2017 Okta, Inc.
  ~
  ~ Licensed under the Apache License, Version 2.0 (the "License");
  ~ you may not use this file except in compliance with the License.
  ~ You may obtain a copy of the License at
  ~
  ~     https://www.apache.org/licenses/LICENSE-2.0
  ~
  ~ Unless required by applicable law or agreed to in writing, software
  ~ distributed under the License is distributed on an "AS IS" BASIS,
  ~ WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  ~ See the License for the specific language governing permissions and
  ~ limitations under the License.
  -->
<html xmlns:th="https://www.thymeleaf.org">
<head>
    <title>Login</title>
    <!--/*/ <th:block th:include="head :: head"/> /*/-->
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.13.0/js/okta-sign-in.min.js" type="text/javascript"></script>
    <link href="/css/okta.css" rel="stylesheet" type="text/css"/>
    <link href="https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.13.0/css/okta-sign-in.min.css" type="text/css" rel="stylesheet"/>
    <link href="https://ok1static.oktacdn.com/assets/js/sdk/okta-signin-widget/2.13.0/css/okta-theme.css" type="text/css" rel="stylesheet"/>
    <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
    <meta th:name="_csrf" th:content="${_csrf.token}"/>
    <meta th:name="_csrf_header" th:content="${_csrf.headerName}"/>

</head>
<body class="login">
  <div id="sign-in-widget"></div>

<script th:inline="javascript">
/*<![CDATA[*/
var orgUrl = "https://www.vivelo.tv/dashboardHome";
var config = {};

config.baseUrl = [[${oktaBaseUrl}]]; /*'https://{yourOktaDomain}';*/
config.clientId = [[${oktaClientId}]]; /* '{clientId}';*/
config.redirectUri = [[${redirectUri}]]; /*'{redirectUri}';*/
config.logo = '/images/logo.png';
config.authParams = {
  issuer: [[${issuerUri}]], /*'{issuerUri}',*/
  responseType: 'code',
  state: [[${state}]], /*'{state}' || false,*/
  nonce: [[${nonce}]], /*'{nonce}',*/
  scopes: [[${scopes}]], /*'[scopes]',*/
  display: 'page'
};

config.registration= {

        parseSchema: function(schema, onSuccess, onFailure) {
           // handle parseSchema callback
           onSuccess(schema);
        },
        preSubmit: function (postData, onSuccess, onFailure) {
           // handle preSubmit callback
           onSuccess(postData);
        },
        postSubmit: function (response, onSuccess, onFailure) {
            // handle postsubmit callback
           onSuccess(response);
           console.log("#### Response: " + response);
           console.log("#### Usuario registrado con exito: " + response.status);
           
        }
      };
      
config.features= {
        // Used to enable registration feature on the widget.
        // https://github.com/okta/okta-signin-widget#feature-flags
         registration: true // REQUIRED
      }

config.i18n={
      en: {
        // Labels
        'remember':'Recordarme',
        'needhelp':'Necesitas ayuda para iniciar sesión?',

        // Labels
        'primaryauth.title': 'Iniciar Sesión',
        'primaryauth.username.placeholder': 'Usuario',
        'primaryauth.username.tooltip': 'Ingrese su usuario',
        'primaryauth.password.placeholder': 'Contraseña',
        'primaryauth.password.tooltip': 'Ingrese su contraseña',
        'primaryauth.submit': 'Iniciar Sesión',
        'goback':'Regresar',
        'forgotpassword' :'Recuperar contraseña',

        // Errors
        'error.username.required': 'Por favor ingrese su usuario',
        'error.password.required': 'Por favor ingrese su contraseña',
        'errors.E0000004': 'Fallo de inicio de sesión!',
        'model.validation.field.blank' :'Este campo debe ser llenado',
        'model.validation.field.wrong.type': 'Este campo tiene un tipo de dato incorrecto',
        'model.validation.field.invalid': 'Este campo tiene un valor no válido',
        'model.validation.field.value.not.allowed':'Este valor no es permitido',
        'model.validation.field.array.minItems':'Este arreglo no tiene suficientes elementos',
        'model.validation.field.array.maxItems':'Este arreglo con tiene muchos elementos',
        'model.validation.field.array.unique':'Este arreglo puede tener solo valores únicos',

        'model.validation.field.string.minLength':'Este campo tiene una longitud muy corta',
        'model.validation.field.string.maxLength':'Este campo execede la longitud permitida',
        'model.validation.field.invalid.format.email':'Correo no válido',
        'model.validation.field.invalid.format.uri':'URL no válida',
        'model.validation.field.invalid.format.ipv4':'Dirección IPv4 no válida',
        'model.validation.field.invalid.format.hostname':'Hostname no válido',
        'model.validation.field.username':'Por favor revise su nombre de usuario',

        //Registration
        'registration.signup.text':'Registrate aquí',
        'registration.signup.label':'¿No tienes cuenta?',
        'registration.form.title':'Crear cuenta',
        'registration.form.submit':'Registrarse',
        'registration.required.fields.label':'Llenar los campos requeridos',
        'registration.complete.title':'Email de verificación enviado',
        'registration.complete.confirm.text':'Verifica tu cuenta, te hemos enviado un correo.',
        'registration.error.userName.invalidEmail':'Email no válido',
        'registration.error.password.passwordRequirementsNotMet':'Contraseña no cumple con la política establecida',
        'registration.error.userName.notUniqueWithinOrg':'Ya existe una cuenta creada con el email proporcionado',

        'password.forgot.sendEmail':'Enviar email de recuperación',
        'password.forgot.email.or.username.placeholder':'Email o Usuario',
        'password.forgot.email.or.username.tooltip':'Ingrese Email o Usuario',
        'password.forgot.question.submit':'Resetear contraseña',
        'password.forgot.emailSent.title':'Email enviado!',
        'password.forgot.emailSent.desc':'Hemos enviado un email a {0} con instrucciones para recuperar tu contraseña.',
        'password.forgot.question.title':'Preguntas y respuestas para recuperación de contraseña',
        'password.forgot.question.submit':'Recuperar contraseña',

        'account.unlock.emailSent.title':'Email enviado!',
        'account.unlock.emailSent.desc':'Hemos enviado un email a {0} con instrucciones para desbloquear tu cuenta.',
        'account.unlock.title':'Desbloquear cuenta',
        'account.unlock.email.or.username.placeholder':'Email o usuario',
        'account.unlock.email.or.username.tooltip':'Ingrese email o usuario',
        'account.unlock.sendText':'Enviar SMS',
        'account.unlock.voiceCall':'Llamada telefónica',
        'account.unlock.sendEmail':'Enviar Email',

        //Social auth
        'socialauth.divider.text':'O',
        'socialauth.facebook.label':'Iniciar con Facebook'

      }
  }
/*********************************************************/
/* ADD ME TO CONFIGURE SOCIAL LOGIN!!!                   */
config.idps = [
  {type: 'FACEBOOK', id: '0oahjn0omYTcpOmE74x6'}
];
/*********************************************************/

function ready(fn) {
  if (document.attachEvent ? document.readyState === "complete" : document.readyState !== "loading") {
    fn();
  } else {
    document.addEventListener('DOMContentLoaded', fn);
  }
}

var oktaSignIn = new OktaSignIn(config);

function renderEl() {

  oktaSignIn.renderEl(
    {el: '#sign-in-widget'},
    function success(res) {
      if (res.status === 'ACTIVATION_EMAIL_SENT') {
          console.log('Correo de activación enviado para: ', res.username);

          var token = $("meta[name='_csrf']").attr("content"); 
          var header = $("meta[name='_csrf_header']").attr("content");

          let userEc2 = {
            userName: res.username,
            email:res.username
        }

        $.ajax({
            url: '/saveUser',
            type: 'post',
            dataType: 'json',
            beforeSend: function(xhr){xhr.setRequestHeader(header, token);},
            contentType: 'application/json',
            success: function (data) {
              console.log('Procesando registro de usuario localmente: ', res.username);
            },
            data: JSON.stringify(userEc2)
        });

        }
    },
    function error(err) {
      console.error(err);
    }
  );
}


if (oktaSignIn.tokenManager.get('idToken')) {
  console.log('logged in');
} else if (oktaSignIn.token.hasTokensInUrl()) {
  oktaSignIn.token.parseTokensFromUrl(
    function success(res) {
      res.forEach(function(token) {
        if (token.accessToken) {
          oktaSignIn.tokenManager.add('accessToken', token);
        } else if (token.idToken) {
          oktaSignIn.tokenManager.add('idToken', token);
        }
      });
      console.log('parsed tokens and logged in: ' + res);

    },
    function error(err) {
      console.error('error', err);
    }
  );
} else {
  ready(renderEl);
}

/*]]>*/
</script>

</body>
</html>
